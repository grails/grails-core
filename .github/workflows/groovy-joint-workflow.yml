name: "Groovy Joint Validation Build"
on:
  push:
    branches:
      - '[4-9]+.[0-9]+.x'
  pull_request:
    branches:
      - '[4-9]+.[0-9]+.x'
  workflow_dispatch:
permissions:
  contents: read
jobs:
  build_groovy:
    runs-on: ubuntu-latest
    outputs:
      groovyVersion: ${{ steps.groovy-version.outputs.value }}
    steps:
      - name: "☕️ Setup JDK"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: "🗄️Cache local Maven repository"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: cache-local-maven-${{ github.sha }}
      - name: "📥 Checkout Groovy 4_0_X (Grails 7 and later)"
        run: git clone --depth 1 https://github.com/apache/groovy.git -b GROOVY_4_0_X --single-branch
      - name: "🐘 Setup Gradle"
        uses: gradle/actions/setup-gradle@v4
        with:
          develocity-access-key: ${{ secrets.GRADLE_ENTERPRISE_ACCESS_KEY }}
      - name: "📝 Store Groovy version to use when building Grails"
        id: groovy-version
        run: |
          cd groovy
          echo "value=$(cat gradle.properties | grep groovyVersion | cut -d\= -f2 |  tr -d '[:space:]')" >> $GITHUB_OUTPUT
      - name: "🔨 Publish Groovy to local maven repository (no docs)"
        env:
          DEVELOCITY_INJECTION_ENABLED: true
          DEVELOCITY_URL: 'https://ge.grails.org'
          DEVELOCITY_PLUGIN_VERSION: '3.18.1'
          DEVELOCITY_CCUD_PLUGIN_VERSION: '2.0.2'
        run: |
          cd groovy
          ./gradlew pTML -x groovydoc -x javadoc -x javadocAll -x groovydocAll -x asciidoc -x docGDK

  build_grails:
    needs: [build_groovy]
    runs-on: ubuntu-latest
    steps:
      - name: "📥 Checkout project"
        uses: actions/checkout@v4
      - name: "☕️ Setup JDK"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: "🐘 Setup Gradle"
        uses: gradle/actions/setup-gradle@v4
        with:
          develocity-access-key: ${{ secrets.GRADLE_ENTERPRISE_ACCESS_KEY }}
      - name: "🗄️Restore local Maven repository from cache"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: cache-local-maven-${{ github.sha }}
      - name: "🪶 Add mavenLocal repository to build"
        run: sed -i 's|// mavenLocal() // Keep|mavenLocal() // Keep|' build.gradle
      - name: "🔨 Build and test Grails using the locally built Groovy snapshot"
        env:
          DEVELOCITY_INJECTION_ENABLED: true
          DEVELOCITY_URL: 'https://ge.grails.org'
          DEVELOCITY_PLUGIN_VERSION: '3.18.1'
          DEVELOCITY_CCUD_PLUGIN_VERSION: '2.0.2'
        run: >
          ./gradlew build
          -PgroovyVersion=${{needs.build_groovy.outputs.groovyVersion}}
          -x groovydoc
